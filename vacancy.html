<!doctype html>
<html lang="en">
  <head>
    <title>JobBoard &mdash; Vacancies</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Find your perfect job across various industries" />
    <meta name="keywords" content="jobs, vacancies, employment, job search" />
    
    <style>
        /* Custom Styles */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
            line-height: 1.6;
        }
        .site-section {
            padding: 4rem 0;
        }
        .job-listing {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            padding: 1rem;
            transition: transform 0.3s ease;
        }
        .job-listing:hover {
            transform: translateY(-5px);
        }
        .job-title-link {
            color: #2c3e50;
            text-decoration: none;
            font-weight: bold;
        }
        .job-title-link:hover {
            color: #3498db;
        }
        .badge-primary {
            background-color: #3498db;
            color: white;
        }
        #loading-spinner {
            display: none;
            margin: 2rem auto;
        }
        .alert {
            padding: 1rem;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 5px;
            margin-top: 1rem;
        }
        @media (max-width: 768px) {
            .job-listing-about {
                flex-direction: column !important;
            }
            .job-listing-position, 
            .job-listing-location, 
            .job-listing-meta {
                width: 100% !important;
                text-align: left !important;
                margin-bottom: 0.5rem;
            }
        }
    </style>
  </head>
  <body>
    <div class="site-wrap">
        <!-- Navigation remains the same as in original file -->
        <header class="site-navbar mt-3">
            <!-- Navigation HTML from original file -->
        </header>

        <!-- VACANCY SEARCH SECTION -->
        <section class="home-section section-hero overlay bg-image" style="background-image: url('images/hero_1.jpg');" id="home-section">
            <div class="container">
                <div class="row align-items-center justify-content-center">
                    <div class="col-md-12">
                        <div class="mb-5 text-center">
                            <h1 class="text-white font-weight-bold">Find Your Perfect Job</h1>
                            <p>Explore top vacancies across various industries</p>
                        </div>
                        
                        <!-- Vacancy Filters -->
                        <div class="row mb-5">
                            <div class="col-md-4 mb-3">
                                <input type="text" id="keyword-filter" class="form-control form-control-lg" placeholder="Job Title or Keyword">
                            </div>
                            <div class="col-md-4 mb-3">
                                <select id="location-filter" class="form-control form-control-lg">
                                    <option value="">All Locations</option>
                                    <option value="london">London</option>
                                    <option value="manchester">Manchester</option>
                                    <option value="remote">Remote</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button type="button" onclick="filterVacancies()" class="btn btn-primary btn-lg btn-block text-white">
                                    <span class="icon-filter icon mr-2"></span>Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VACANCIES SECTION -->
        <section class="site-section">
            <div class="container">
                <div class="row mb-5 justify-content-center">
                    <div class="col-md-7 text-center">
                        <h2 class="section-title mb-2">Top Vacancies</h2>
                        <p id="results-count"></p>
                    </div>
                </div>
                
                <div id="loading-spinner" class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>

                <div id="vacancies-container">
                    <!-- Vacancies dynamically loaded here -->
                </div>

                <div class="row mt-5">
                    <div class="col-md-12 text-center">
                        <button id="load-more-btn" class="btn btn-primary btn-lg" onclick="loadMoreVacancies()">
                            Load More Vacancies
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
    // Vacancy page script for dynamic job loading and filtering
    let currentPage = 1;
    const jobsPerPage = 10;
    let allVacancies = [];
    let filteredVacancies = [];

    // Enhanced Error Handling Fetch Function
    async function fetchVacancies(query = 'top') {
        const loadingSpinner = document.getElementById('loading-spinner');
        const vacanciesContainer = document.getElementById('vacancies-container');
        const resultsCount = document.getElementById('results-count');

        loadingSpinner.style.display = 'block';
        vacanciesContainer.innerHTML = '';
        resultsCount.textContent = '';

        try {
            const response = await fetch(`https://api.lmiforall.org.uk/api/v1/vacancies/search?keywords=${encodeURIComponent(query)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const jobs = await response.json();

            if (!jobs || jobs.length === 0) {
                vacanciesContainer.innerHTML = `
                    <div class="alert text-center" role="alert">
                        No vacancies found. Please try a different search.
                    </div>
                `;
                return [];
            }

            return jobs;
        } catch (error) {
            console.error('Error fetching vacancies:', error);
            vacanciesContainer.innerHTML = `
                <div class="alert text-center" role="alert">
                    Failed to load vacancies. Please try again later. 
                    ${error.message}
                </div>
            `;
            return [];
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    // Display vacancies with enhanced formatting
    function displayVacancies() {
        const vacanciesContainer = document.getElementById('vacancies-container');
        const resultsCount = document.getElementById('results-count');
        const startIndex = (currentPage - 1) * jobsPerPage;
        const endIndex = startIndex + jobsPerPage;
        const vacaciesToShow = filteredVacancies.slice(startIndex, endIndex);

        resultsCount.textContent = `Showing ${vacaciesToShow.length} of ${filteredVacancies.length} vacancies`;

        let vacanciesHTML = `<div class="job-listings">`;
        
        vacaciesToShow.forEach(job => {
            // Safely extract job details with fallbacks
            const title = job.title || 'Job Title Not Available';
            const company = job.company || 'Company Not Specified';
            const location = (job.location && job.location.area) || 'Location Not Specified';
            const link = job.url || '#';
            const type = job.type || 'Full-time';

            vacanciesHTML += `
                <div class="job-listing d-block d-sm-flex pb-3 pb-sm-0 align-items-center">
                    <div class="job-listing-about d-sm-flex custom-width w-100 justify-content-between mx-4">
                        <div class="job-listing-position custom-width w-50 mb-3 mb-sm-0">
                            <h2>
                                <a href="${escapeHTML(link)}" target="_blank" class="job-title-link">
                                    ${escapeHTML(title)}
                                </a>
                            </h2>
                            <strong>${escapeHTML(company)}</strong>
                        </div>
                        <div class="job-listing-location mb-3 mb-sm-0 custom-width w-25">
                            <span class="icon-room"></span> 
                            ${escapeHTML(location)}
                        </div>
                        <div class="job-listing-meta custom-width w-25 text-right">
                            <span class="badge badge-primary mr-2">${escapeHTML(type)}</span>
                            <a href="${escapeHTML(link)}" target="_blank" class="btn btn-primary btn-sm">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            `;
        });
        
        vacanciesHTML += `</div>`;
        
        // Append or replace vacancies
        if (currentPage === 1) {
            vacanciesContainer.innerHTML = vacanciesHTML;
        } else {
            vacanciesContainer.innerHTML += vacanciesHTML;
        }

        // Manage Load More button visibility
        const loadMoreBtn = document.getElementById('load-more-btn');
        loadMoreBtn.style.display = filteredVacancies.length > endIndex ? 'block' : 'none';
    }

    // Comprehensive Filtering Function
    async function filterVacancies() {
        const keywordFilter = document.getElementById('keyword-filter').value.toLowerCase().trim();
        const locationFilter = document.getElementById('location-filter').value.toLowerCase();

        // If no keyword, fetch default top vacancies
        const query = keywordFilter || 'top';
        
        // Fetch vacancies based on keyword
        allVacancies = await fetchVacancies(query);

        // Reset pagination
        currentPage = 1;

        // Apply filters
        filteredVacancies = allVacancies.filter(job => {
            const matchKeyword = !keywordFilter || 
                (job.title && job.title.toLowerCase().includes(keywordFilter)) ||
                (job.company && job.company.toLowerCase().includes(keywordFilter));
            
            const matchLocation = !locationFilter || 
                (job.location && job.location.area && 
                 job.location.area.toLowerCase().includes(locationFilter));
            
            return matchKeyword && matchLocation;
        });

        // Display filtered results
        displayVacancies();
    }

    // Load more vacancies
    function loadMoreVacancies() {
        currentPage++;
        displayVacancies();
    }

    // HTML Escaping to prevent XSS
    function escapeHTML(str) {
        if (!str) return '';
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Initialize page with top vacancies
    document.addEventListener('DOMContentLoaded', async () => {
        allVacancies = await fetchVacancies();
        filteredVacancies = [...allVacancies];
        displayVacancies();
    });
    </script>
  </body>
</html>